From 1ad4f5e3d4582f8af6a2f0370e7442ffc2f19276 Mon Sep 17 00:00:00 2001
From: Xiaoyao Li <xiaoyao.li@intel.com>
Date: Thu, 24 Feb 2022 16:12:36 +0800
Subject: [PATCH 084/101] i386/tdx: Implement debug property

Signed-off-by: Xiaoyao Li <xiaoyao.li@intel.com>
---
 qapi/qom.json         |  5 ++++-
 target/i386/kvm/tdx.c | 24 ++++++++++++++++++++++++
 2 files changed, 28 insertions(+), 1 deletion(-)

diff --git a/qapi/qom.json b/qapi/qom.json
index 01d2b3e84b..27e12d59a7 100644
--- a/qapi/qom.json
+++ b/qapi/qom.json
@@ -859,6 +859,8 @@
 #
 # @quote-generation-service: socket address for Quote Generation Service(QGS)
 #
+# @debug: Whether it's a debug TD or not (default: 0)
+#
 # Since: 8.2
 ##
 { 'struct': 'TdxGuestProperties',
@@ -866,7 +868,8 @@
             '*mrconfigid': 'str',
             '*mrowner': 'str',
             '*mrownerconfig': 'str',
-            '*quote-generation-service': 'str' } }
+            '*quote-generation-service': 'str',
+            '*debug': 'bool' } }
 
 ##
 # @ThreadContextProperties:
diff --git a/target/i386/kvm/tdx.c b/target/i386/kvm/tdx.c
index 82c6e852a2..949997bd57 100644
--- a/target/i386/kvm/tdx.c
+++ b/target/i386/kvm/tdx.c
@@ -729,10 +729,12 @@ static int tdx_validate_attributes(TdxGuest *tdx)
             return -EINVAL;
     }
 
+    /*
     if (tdx->attributes & TDX_TD_ATTRIBUTES_DEBUG) {
         error_report("Current QEMU doesn't support attributes.debug[bit 0] for TDX VM");
         return -EINVAL;
     }
+    */
 
     return 0;
 }
@@ -883,6 +885,24 @@ static void tdx_guest_set_sept_ve_disable(Object *obj, bool value, Error **errp)
     }
 }
 
+static bool tdx_guest_get_debug(Object *obj, Error **errp)
+{
+    TdxGuest *tdx = TDX_GUEST(obj);
+
+    return !!(tdx->attributes & TDX_TD_ATTRIBUTES_DEBUG);
+}
+
+static void tdx_guest_set_debug(Object *obj, bool value, Error **errp)
+{
+    TdxGuest *tdx = TDX_GUEST(obj);
+
+    if (value) {
+        tdx->attributes |= TDX_TD_ATTRIBUTES_DEBUG;
+    } else {
+        tdx->attributes &= ~TDX_TD_ATTRIBUTES_DEBUG;
+    }
+}
+
 static char *tdx_guest_get_quote_generation(
     Object *obj, Error **errp)
 {
@@ -927,6 +947,10 @@ static void tdx_guest_init(Object *obj)
     object_property_add_bool(obj, "sept-ve-disable",
                              tdx_guest_get_sept_ve_disable,
                              tdx_guest_set_sept_ve_disable);
+    object_property_add_bool(obj, "debug",
+                             tdx_guest_get_debug,
+                             tdx_guest_set_debug);
+
     object_property_add_sha384(obj, "mrconfigid", tdx->mrconfigid,
                                OBJ_PROP_FLAG_READWRITE);
     object_property_add_sha384(obj, "mrowner", tdx->mrowner,
-- 
2.39.2

